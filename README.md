# ï»¿<a name="_9h4p1coakp1j"></a>remote-control Design

Remote command execution

# <a name="_g7gm0m4ewxo6"></a>What
The remote control (rc) provides a means to execute remote commands on a Linux server

# <a name="_h1h63640ztqs"></a>Why
rc will allow support techs to log into customer's Linux servers and execute shell commands to troubleshoot customer issues.

# <a name="_n02bd3awbvj8"></a>Details
rc is split into two executables: agent and client. client runs in support's environment and sends arbitrary shell commands to agent, which is installed on the customers' Linux box. agent is responsible for executing the received commands and stores the results. The agent and client communicate over gRPC.


# <a name="_isobl31grue1"></a>client usage
rc-client consists of the sub commands start, stop status and output. All the commands except output return JSON. output streams the output of a command.

If the comand sent to the agent fails for some reason, the `client` will exit with the same error code as was returned from the agent.

The following options are common to all subcommands:


```
  Options:

  -help
    	print help
  -host string
    	remote host to connect to (default "127.0.0.1")

  -port int
    	remote port to connect to (default 50051)

```

### <a name="_ibnjqdwwhvf0"></a>start subcommand
start starts a new shell command on the remote server.

`Usage: client start [options] -- <command> [command arguments].`

Output:
```json
{

  "id": "<unique UUID>"

}
```
id: a UUID generated by the agent that can be used to stop or status commands, 

### <a name="_an8sl31hy99k"></a>status subcommand
The status command retrieves information about a previously started command:

`Usage: trc-client [options] status <command id>`

Get status of a previously started command.

Output:
```json
{
     "id": "<command UUID>",
     "status": "[running,completed,stopped,error]",
     "error": "null|error message",
     "exit_status": "command exit status"
}
```
```
Where status is one of the following:

  running: The command is still running

  completed: The command ran to completion

  stopped: The command was stopped prematurely by a `stop` command to the agent

  error: The command failed to start
```

### <a name="_vmj8dmfecyrn"></a>output subcommand
The output subcommand returns output of a command. If the command is still running on the remote machine, the output will be live streamed until the command finishes or is stopped by another trc command. If the command is not running, it will exit after all lines have been displayed. Both stdout AND stderr are included in the output.

`Usage: client [options] output <command id>`

Stream the output of a command


Output:
```
command output line1
command output line2
command output line3
```
### <a name="_xwvk9ga52s"></a>stop subcommand
The stop command stops a running command. If the command is not running, or stopping the command fails, an error is returned.
`Usage: client [options] stop <command id>`
Output:
```

```

# <a name="_lzxdkro76353"></a>trc-agent usage

The agent requires the following options:
`Usage: rc-agent -ca-cert -key -host-cert`

Options:

  -help
     print help and exit 

  -ca-cert string
	path to the host's self signed CA certificate

  -key string
	path to the hosts key file

  -port
      port the agent should listen on

  -host-cert
	path to the host cert signed by the ca-cert




# <a name="_l5xtktkosihk"></a>gRPC Protocol
The protobuf message definitions for sending and receiving commands between the client and agent:
```proto
service TrcAgent{
    // Start a new command
    rpc Start(StartRequest) returns (StartResponse);
    // Stream the output of a command
    rpc Output(OutputRequest) returns (stream OutputResponse);
    // Get the status of a command
    rpc Status(StatusRequest) returns (StatusResponse);
    // Stop a running command
    rpc Stop(StopRequest) returns (StopResponse);
}

message StartRequest {
    // command to execute
    required string command = 1;
    // arguments to the command
    repeated string args = 2; //
}

message StartResponse {
    // return the command ID of started command
    required string id = 1;
}

message OutputRequest {
    // ID of the command to retrieve the output of
    required string id = 1;
}

message OutputResponse {
    // output of the command
    required bytes output = 1;
}

message StatusRequest {
    // id of the command to status
    required string id = 1;
}

message StatusResponse {
    // command ID
    required string id = 1;
    // command which was executed
    required string cmd = 2;
    // args to the command
    repeated string args = 3;
    // current state of the command
    required State state = 4;
    // exit status of the command
    required int32 exit = 6;
}
message StopRequest {
    // ID of the command to stop
    required string id = 1;
}

message StopResponse {
    // ID of the command stopped
    required string id = 1;
}

enum State {
    // Default the state is unknown
    UNKNOWN = 0;
    // The command ran to completion
    COMPLETE = 1;
    // The command was stopped prematurely by Stop()
    STOPPED = 2;
    // There was an error starting the command
    ERROR = 3;
    // The command is running
    RUNNING = 4;
    // The command has not started yet
    PENDING = 5;
}


```


